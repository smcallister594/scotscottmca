---
title: Expanding IME Log Retention
date: 2023-09-27
last_modified_at: 2023-09-27
tags: [Intune, Error Codes, logs, log collection, Intune Management Extension, IME]
Author: Scott McAllister
Draft: false
---

## What are we talking about here?

Logs, Again!

This is a bit of a followup on my last post about [collecting log files using Intune](https://scotscottmca.com/posts/ExpandingIMELogRetention/). 

The log files generated by the Intune Management Extension are extremely useful when troubleshooting a variety of issues, although I focus primarily on Win32 app related problems. 

Recently, I have noticed that the IntuneManagementExtension.log is filled with more and more information about the GRSManager, Win32AppInventory and ReevaluationScheduleManager as well as log lines related specifically to Win32 app installations which generate a vast amount of log lines.

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/GRSManager.png?raw=true)

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/ReevaluationScheduleManager.png?raw=true)

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/Win32AppInventory.png?raw=true)

While these log lines can be useful, the sheer volume of them can cause the IntuneManagementExtension.log and AgentExecutor.log to fill up and roll over very quickly. 

This can be pretty annoying for troubleshooting, as by default the IME is only configured to retain 3 logs (Current + 2 roll overs. Rollover occurs at 3MB by default). So when you get around to collecting logs, any information related to the issue you're experiencing is potentially long gone. 

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/IMELogsFolder.png?raw=true)

## What can we do about it?

Well, thankfully we can fix this relatively easily. 

There are 2 registry keys that we can create that control the size at which the logs rollover, and how many rolled over logs we keep. 

The registry keys that control this are not set by default, so it isn't immediately obvious what needs changed. 

We want to create LogMaxHistory and LogMaxSize under HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\IntuneWindowsAgent\Logging and configure them accordingly. 

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/LoggingRegKeys.png?raw=true)

In this example, I want to keep 6 logs and rollover at 5MB. 

![image](https://github.com/smcallister594/scotscottmca/blob/main/assets/images/LogRetention/LoggingRegKeys_1.png?raw=true)

{{< admonition type=tip title="Note" open=true >}}
The more logs retained, and the increased size of the logs can potentially impact disk space on your devices
{{< /admonition >}}

And, like everything you can do this programatically with PowerShell and Proactive Remediation!

### Proactive Remediation 

#### Detection
{{< highlight PowerShell >}}
# Check if keys are already set

# IME Logging settings path
$regKeyFullPath = "HKLM:\SOFTWARE\Microsoft\IntuneWindowsAgent\Logging"

# check if the registry key exists
$ExpectedLogMaxSize = 5242880
$ExpextedLogMaxHistory = 6
$LogMaxSize = Get-ItemProperty -Path $regKeyFullPath -Name "LogMaxSize" -ErrorAction SilentlyContinue
$LogMaxHistory = Get-ItemProperty -Path $regKeyFullPath -Name "LogMaxHistory" -ErrorAction SilentlyContinue

if ($LogMaxSize -eq $ExpectedLogMaxSize -and $LogMaxHistory -eq $ExpextedLogMaxHistory) {
    exit 1
} else {
    exit 0
}
{{< /highlight >}}

#### Remediation

{{< highlight PowerShell >}}
# IME Logging settings path
$regKeyFullPath = "HKLM:\SOFTWARE\Microsoft\IntuneWindowsAgent\Logging"

try{
    if (Test-Path -Path $regKeyFullPath){
        continue
    }
    else{
        New-Item -Path $regKeyFullPath -Force | Out-Null
    }
    
    # Set LogMaxSize to 5MB
    Set-ItemProperty -Path $regKeyFullPath -Name "LogMaxSize" -Value "5242880" -Type String -Force
    
    # Set LogMaxHistory to 6
    Set-ItemProperty -Path $regKeyFullPath -Name "LogMaxHistory" -Value "6" -Type String -Force
} catch {
    Write-Error "Unable to set registry keys: $_"
    exit 1
}
{{< /highlight >}}

Here's a handy video from [Intune.Training](https://Intune.Training) showing how to configure Proactive Remediation to deploy the Detection and Remediation scripts.

[Intune Training - S02E09 - How to Configure Proactive Remediations in Microsoft Intune](https://www.youtube.com/watch?v=VOBzV6GjOvI)


## Summary

Not much to summarize other than it can be useful to keep more than the default number of retained logs!